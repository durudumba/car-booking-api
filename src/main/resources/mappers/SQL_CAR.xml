<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTO Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.raontec.carbookingapi.data.CarDAO">
    <select id="selectCarList" parameterType="map" resultType="map">
            SELECT
                A.CAR_NUM,
                A.CAR_MODL,
                (SELECT COMM_CD_NAME FROM TB_COMM_CD WHERE COMM_CD = A.FUEL_TYPE_CD) AS FUEL_TYPE,
                A.FUEL_TYPE_CD,
                A.RMRK,
                (SELECT PARK_LOC FROM TB_PARK_LOC WHERE CAR_NUM = A.CAR_NUM) AS PARK_LOC,
                TO_CHAR(A.REG_DT, 'YYYY-MM-DD HH24:MI:SS') AS REG_DT
            FROM
                TB_CAR A
            WHERE 1=1
                AND DEL_YN = 'N'
                AND CAR_NUM NOT IN (
                    SELECT
                        CAR_NUM
                    FROM
                        TB_CAR_BOOK_SCHD
                    WHERE 1=1
                        AND
                            CASE STRT_TMCD
                                WHEN 'TDC2' THEN STR_TO_DATE(#{eddt}, '%Y-%m-%d %H%i%s') <![CDATA[>]]> DATE_ADD(STRT_DT, INTERVAL 14 HOUR)
                                ELSE STR_TO_DATE(#{eddt}, '%Y-%m-%d %H%i%s') <![CDATA[>]]> DATE_ADD(STRT_DT, INTERVAL 0 HOUR) END
                        AND
                            CASE END_TMCD
                                WHEN 'TDC1' THEN STR_TO_DATE(#{stdt}, '%Y-%m-%d %H%i%s') <![CDATA[<]]> DATE_ADD(END_DT, INTERVAL 14 HOUR)
                                ELSE STR_TO_DATE(#{stdt}, '%Y-%m-%d %H%i%s') <![CDATA[<]]> DATE_ADD(END_DT, INTERVAL 23*60 + 59 MINUTE) END
                )
    </select>

    <delete id="deleteExpiredSchedule">
        DELETE FROM
            TB_CAR_BOOK_SCHD
        WHERE 1=1
            AND STRT_DT <![CDATA[<]]> NOW()
            AND END_DT <![CDATA[<]]> NOW()
    </delete>
</mapper>